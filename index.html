<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baseball Stats Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        ::placeholder { color: #9ca3af; opacity: 1; }
        th, td { white-space: nowrap; }
        
        .stepper-btn {
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
            border-radius: 9999px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3a8a;
            transition: all 0.2s;
            user-select: none;
        }
        .stepper-btn:hover { background-color: #e5e7eb; }
        .stepper-btn:active { transform: scale(0.9); }
        .stepper-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #navSidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #navSidebar.active {
            transform: translateX(0);
        }

        #overlay {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        #overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .sub-tab-btn {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .sub-tab-btn.active {
            color: #1e293b;
            border-bottom-color: #1e293b;
        }

        /* Live Game Specifics */
        .ab-btn {
            padding: 1.5rem 0;
            border-radius: 0.75rem;
            font-weight: 900;
            font-size: 1.25rem;
            transition: all 0.1s;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }
        .ab-btn:active { transform: translateY(2px); box-shadow: none; }
        
        .hit-btn { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .hit-btn:hover { background-color: #bfdbfe; }
        
        .walk-btn { background-color: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
        .walk-btn:hover { background-color: #e5e7eb; }
        
        .out-btn { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .out-btn:hover { background-color: #fecaca; }

        .live-step { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-slate-900 overflow-x-hidden">

    <div id="overlay" onclick="closeAllMenus()" class="fixed inset-0 bg-slate-900/50 z-[60]"></div>
    <input type="file" id="csvImportInput" accept=".csv" class="hidden" onchange="handleCsvImport(event)">

    <!-- Navigation Sidebar -->
    <aside id="navSidebar" class="fixed top-0 left-0 h-full w-64 bg-white z-[70] shadow-2xl p-6">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-lg font-black text-blue-900 tracking-tight">MENU</h2>
            <button onclick="toggleNav(false)" class="p-2 hover:bg-slate-100 rounded-full transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav class="flex flex-col gap-2">
            <button onclick="showPage('dashboard')" class="flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition text-left">Dashboard</button>
            <button onclick="showPage('liveGame')" class="flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition text-left">
                <span class="text-red-500 mr-1">●</span> Live Game
            </button>
            <button onclick="showPage('addData')" class="flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition text-left">Add Past Game</button>
            <button onclick="showPage('glossary')" class="flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition text-left">Glossary</button>
            <button onclick="showPage('dataManagement')" class="flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition text-left">Data Management</button>
        </nav>
    </aside>

    <div class="max-w-6xl mx-auto">
        <header class="bg-white border-b sticky top-0 z-40 px-4 md:px-8">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center gap-4">
                    <button onclick="toggleNav(true)" class="p-2 hover:bg-slate-100 rounded-lg transition text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 class="text-xl font-black text-blue-900 tracking-tight">BASEBALL STATS</h1>
                </div>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <h2 id="pageTitle" class="text-2xl font-bold mb-6 text-slate-800">Dashboard</h2>

            <!-- DASHBOARD -->
            <div id="dashboardPage" class="page-view">
                <!-- (Dashboard content preserved) -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="stats-card border-t-4 border-blue-500">
                        <p class="text-slate-400 text-[10px] uppercase font-black tracking-wider">AVG</p>
                        <p id="avgDisplay" class="text-3xl font-black text-slate-800">.000</p>
                    </div>
                    <div class="stats-card border-t-4 border-red-500">
                        <p class="text-slate-400 text-[10px] uppercase font-black tracking-wider">OBP</p>
                        <p id="obpDisplay" class="text-3xl font-black text-slate-800">.000</p>
                    </div>
                    <div class="stats-card border-t-4 border-yellow-500">
                        <p class="text-slate-400 text-[10px] uppercase font-black tracking-wider">SLG</p>
                        <p id="slgDisplay" class="text-3xl font-black text-slate-800">.000</p>
                    </div>
                    <div class="stats-card border-t-4 border-green-500">
                        <p class="text-slate-400 text-[10px] uppercase font-black tracking-wider">OPS</p>
                        <p id="opsDisplay" class="text-3xl font-black text-slate-800">.000</p>
                    </div>
                </div>

                <div class="mb-6 border-b border-slate-200 flex gap-1 sm:gap-4 overflow-x-auto no-scrollbar">
                    <button onclick="switchDashTab('performance')" id="dash-tab-performance" class="sub-tab-btn active">Performance</button>
                    <button onclick="switchDashTab('metrics')" id="dash-tab-metrics" class="sub-tab-btn">Metric Profile</button>
                    <button onclick="switchDashTab('distribution')" id="dash-tab-distribution" class="sub-tab-btn">Hit Distribution</button>
                    <button onclick="switchDashTab('log')" id="dash-tab-log" class="sub-tab-btn">Game Log</button>
                </div>

                <div id="dash-section-performance" class="dash-section">
                    <div class="stats-card mb-8">
                        <h3 class="text-sm font-bold mb-6 text-slate-500 uppercase tracking-widest">Season Performance</h3>
                        <div class="h-64"><canvas id="performanceChart"></canvas></div>
                    </div>
                </div>

                <div id="dash-section-metrics" class="dash-section hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="stats-card">
                            <h3 class="text-sm font-bold mb-6 text-slate-500 uppercase tracking-widest text-center">Plate Discipline</h3>
                            <div class="flex justify-around text-center py-4">
                                <div><p class="text-xs font-bold text-slate-400 uppercase">Walks</p><p id="metricBB" class="text-2xl font-black text-slate-800">0</p></div>
                                <div><p class="text-xs font-bold text-slate-400 uppercase">Strikeouts</p><p id="metricSO" class="text-2xl font-black text-slate-800">0</p></div>
                            </div>
                        </div>
                        <div class="stats-card">
                            <h3 class="text-sm font-bold mb-6 text-slate-500 uppercase tracking-widest text-center">Power Metrics</h3>
                            <div class="flex justify-around text-center py-4">
                                <div><p class="text-xs font-bold text-slate-400 uppercase">ISO (Iso Power)</p><p id="metricISO" class="text-2xl font-black text-slate-800">.000</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dash-section-distribution" class="dash-section hidden">
                    <div class="stats-card mb-8">
                        <h3 class="text-sm font-bold mb-6 text-slate-500 uppercase tracking-widest">Hit Type Breakdown</h3>
                        <div class="h-64"><canvas id="distributionChart"></canvas></div>
                    </div>
                </div>

                <div id="dash-section-log" class="dash-section hidden">
                    <div class="stats-card overflow-x-auto mb-8">
                        <table class="min-w-full divide-y divide-slate-100">
                            <thead>
                                <tr class="text-left text-[10px] font-black text-slate-400 uppercase tracking-wider">
                                    <th class="px-4 py-3">Date</th>
                                    <th class="px-4 py-3">Opponent</th>
                                    <th class="px-2 py-3 text-center">AB</th>
                                    <th class="px-2 py-3 text-center">H</th>
                                    <th class="px-2 py-3 text-center">BB</th>
                                    <th class="px-2 py-3 text-center">SO</th>
                                    <th class="px-2 py-3 text-center">AVG</th>
                                    <th class="px-4 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- LIVE GAME PAGE -->
            <div id="liveGamePage" class="page-view hidden max-w-lg mx-auto">
                <div class="stats-card mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="w-full mr-4">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-1">Opponent</label>
                            <input type="text" id="liveOpponent" class="w-full bg-slate-50 border border-slate-200 rounded p-2 text-sm font-bold text-slate-800" placeholder="Enter Team Name" onchange="persistOpponent()">
                        </div>
                        <div class="text-right whitespace-nowrap">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-wider mb-1">Date</label>
                            <p class="text-sm font-bold text-slate-800" id="liveDateDisplay"></p>
                        </div>
                    </div>
                    
                    <!-- Live Scoreboard -->
                    <div class="bg-blue-900 rounded-xl p-4 text-white grid grid-cols-4 gap-2 text-center mb-2 shadow-lg">
                        <div><p class="text-[10px] opacity-60 uppercase">AB</p><p id="liveAB" class="text-2xl font-black">0</p></div>
                        <div><p class="text-[10px] opacity-60 uppercase">H</p><p id="liveH" class="text-2xl font-black">0</p></div>
                        <div><p class="text-[10px] opacity-60 uppercase">RBI</p><p id="liveRBI" class="text-2xl font-black">0</p></div>
                        <div><p class="text-[10px] opacity-60 uppercase">R</p><p id="liveR" class="text-2xl font-black">0</p></div>
                    </div>
                    <div class="text-center">
                         <span class="text-xs text-slate-400 font-bold uppercase">AVG: </span><span id="liveAVG" class="text-sm font-black text-blue-600">.000</span>
                    </div>
                </div>

                <!-- Input Grid -->
                <div id="liveKeypad" class="grid grid-cols-2 gap-3 mb-6 transition-all duration-300">
                    <button onclick="handleLiveResult('s')" class="ab-btn hit-btn">1B</button>
                    <button onclick="handleLiveResult('d')" class="ab-btn hit-btn">2B</button>
                    <button onclick="handleLiveResult('t')" class="ab-btn hit-btn">3B</button>
                    <button onclick="handleLiveResult('hr')" class="ab-btn hit-btn bg-blue-600 text-white hover:bg-blue-700 border-none">HR</button>
                    <button onclick="handleLiveResult('bb')" class="ab-btn walk-btn">BB</button>
                    <button onclick="handleLiveResult('hbp')" class="ab-btn walk-btn">HBP</button>
                    <button onclick="handleLiveResult('so')" class="ab-btn out-btn">SO</button>
                    <button onclick="handleLiveResult('outs')" class="ab-btn out-btn">OUT</button>
                </div>

                <!-- Wizard Context Panel -->
                <div id="liveABContext" class="hidden stats-card bg-slate-50 border border-slate-200 mb-6">
                    <!-- Step 1: RBIs -->
                    <div id="liveStepRBI" class="live-step hidden">
                        <h3 class="text-center font-black text-blue-900 uppercase tracking-wider mb-4">RBIs on play?</h3>
                        <div class="flex items-center justify-center gap-6 mb-6">
                            <button onclick="adjustLiveContext('rbi', -1)" class="stepper-btn bg-white border border-slate-200">-</button>
                            <span id="liveContextRBI" class="text-3xl font-black text-slate-800">0</span>
                            <button onclick="adjustLiveContext('rbi', 1)" class="stepper-btn bg-white border border-slate-200">+</button>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="cancelLiveAB()" class="w-1/3 py-3 rounded-xl bg-slate-200 text-slate-600 font-bold">Cancel</button>
                             <button onclick="nextLiveStep(2)" class="w-2/3 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg">Next</button>
                        </div>
                    </div>

                    <!-- Step 2: SBs -->
                    <div id="liveStepSB" class="live-step hidden">
                        <h3 class="text-center font-black text-blue-900 uppercase tracking-wider mb-4">Stolen Bases?</h3>
                        <div class="flex items-center justify-center gap-6 mb-6">
                            <button onclick="adjustLiveContext('sb', -1)" class="stepper-btn bg-white border border-slate-200">-</button>
                            <span id="liveContextSB" class="text-3xl font-black text-slate-800">0</span>
                            <button onclick="adjustLiveContext('sb', 1)" class="stepper-btn bg-white border border-slate-200">+</button>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="nextLiveStep(1)" class="w-1/3 py-3 rounded-xl bg-slate-200 text-slate-600 font-bold">Back</button>
                             <button onclick="nextLiveStep(3)" class="w-2/3 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg">Next</button>
                        </div>
                    </div>

                    <!-- Step 3: Run -->
                    <div id="liveStepRun" class="live-step hidden">
                        <h3 class="text-center font-black text-blue-900 uppercase tracking-wider mb-4">Did you score?</h3>
                        <div class="flex gap-4 mb-6">
                            <button onclick="setLiveRun(false); nextLiveStep(4)" class="w-1/2 py-4 rounded-xl bg-slate-200 text-slate-600 font-black text-xl hover:bg-slate-300">NO</button>
                            <button onclick="setLiveRun(true); nextLiveStep(4)" class="w-1/2 py-4 rounded-xl bg-green-500 text-white font-black text-xl hover:bg-green-600 shadow-lg shadow-green-100">YES</button>
                        </div>
                         <button onclick="nextLiveStep(2)" class="w-full py-2 text-slate-400 font-bold text-xs uppercase">Back</button>
                    </div>

                    <!-- Step 4: Confirm -->
                    <div id="liveStepConfirm" class="live-step hidden">
                        <h3 class="text-center font-black text-blue-900 uppercase tracking-wider mb-2">Confirm Result</h3>
                        <div id="liveSummaryText" class="text-center text-sm text-slate-600 mb-6 bg-white p-4 rounded-xl border border-slate-100 shadow-sm font-mono"></div>
                        <div class="flex gap-2">
                            <button onclick="cancelLiveAB()" class="w-1/3 py-3 rounded-xl bg-white border border-slate-200 text-slate-500 font-bold">Cancel</button>
                            <button onclick="confirmLiveAB()" class="w-2/3 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg">Save AB</button>
                        </div>
                    </div>
                </div>

                <!-- Extra Controls -->
                <div class="mt-8">
                    <button onclick="finalizeLiveGame()" class="w-full py-3 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-900 shadow-lg transition">
                        Finish Game & Start New
                    </button>
                </div>
            </div>

            <!-- ADD DATA (Past) PAGE -->
            <div id="addDataPage" class="page-view hidden max-w-lg mx-auto space-y-8">
                <!-- Manual Entry Form (Same as before) -->
                <div class="stats-card min-h-[500px] flex flex-col">
                    <div class="flex justify-between items-start mb-6">
                        <h2 id="formHeader" class="text-xl font-bold">Manual Entry</h2>
                        <span id="stepIndicator" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">Step 1 of 13</span>
                    </div>
                    <form id="statsForm" class="flex-grow flex flex-col justify-between">
                        <!-- Step 1: Info -->
                        <div id="step1" class="step-content space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                                <input type="date" id="date" required class="w-full rounded-lg border border-slate-200 p-3 outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Opponent</label>
                                <input type="text" id="opponent" placeholder="Optional" class="w-full rounded-lg border border-slate-200 p-3 outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <!-- (All Steppers for Manual Entry) -->
                        <div id="stepperContainer">
                           <div id="step2" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">At Bats (AB)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('ab', -1)" class="stepper-btn">-</button><input type="number" id="ab" value="0" readonly class="text-5xl font-black w-24 text-center outline-none bg-transparent"><button type="button" onclick="stepVal('ab', 1)" class="stepper-btn">+</button></div><p id="abWarning" class="text-[10px] text-red-500 font-bold hidden uppercase">AB must be ≥ Total Hits + Strikeouts</p></div>
                           <div id="step3" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">Singles (1B)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('s', -1)" class="stepper-btn">-</button><input type="number" id="s" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('s', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step4" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">Doubles (2B)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('d', -1)" class="stepper-btn">-</button><input type="number" id="d" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('d', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step5" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">Triples (3B)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('t', -1)" class="stepper-btn">-</button><input type="number" id="t" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('t', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step6" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">Home Runs (HR)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('hr', -1)" class="stepper-btn">-</button><input type="number" id="hr" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('hr', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step7" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">Strikeouts (SO)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('so', -1)" class="stepper-btn">-</button><input type="number" id="so" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('so', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step8" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">Walks (BB)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('bb', -1)" class="stepper-btn">-</button><input type="number" id="bb" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('bb', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step9" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">Hit by Pitch (HBP)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('hbp', -1)" class="stepper-btn">-</button><input type="number" id="hbp" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('hbp', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step10" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">Runs (R)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('r', -1)" class="stepper-btn">-</button><input type="number" id="r" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('r', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step11" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">RBIs?</p><div class="flex items-center justify-center gap-6"><button type="button" id="rbiMinus" onclick="stepVal('rbi', -1)" class="stepper-btn">-</button><input type="number" id="rbi" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('rbi', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step12" class="step-content hidden text-center space-y-6"><p class="text-slate-500 text-sm font-medium">Stolen Bases (SB)?</p><div class="flex items-center justify-center gap-6"><button type="button" id="sbMinus" onclick="stepVal('sb', -1)" class="stepper-btn">-</button><input type="number" id="sb" value="0" readonly class="text-5xl font-black w-20 text-center bg-transparent"><button type="button" onclick="stepVal('sb', 1)" class="stepper-btn">+</button></div></div>
                           <div id="step13" class="step-content hidden">
                                <div class="bg-blue-50 rounded-xl p-4 border border-blue-100 overflow-y-auto max-h-[300px]">
                                    <h3 class="text-[10px] font-black text-blue-800 uppercase mb-4 text-center">Summary Review</h3>
                                    <div id="fullReviewGrid" class="grid grid-cols-2 gap-y-3 gap-x-6 text-sm"></div>
                                    <div id="reviewCalculated" class="mt-6 pt-4 border-t border-blue-200"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-2 pt-6">
                            <button type="button" id="backBtn" onclick="prevStep()" class="hidden w-1/3 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl">Back</button>
                            <button type="button" id="nextBtn" onclick="handleNext()" class="flex-grow bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">Next</button>
                            <button type="submit" id="submitBtn" class="hidden flex-grow bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg">Save Game</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- GLOSSARY & DATA MGMT -->
            <div id="glossaryPage" class="page-view hidden">
                <div class="stats-card space-y-4"><p class="text-sm">Standard baseball definitions apply.</p></div>
            </div>
            <div id="dataManagementPage" class="page-view hidden max-w-2xl mx-auto space-y-6">
                 <div class="stats-card"><button onclick="exportData()" class="bg-slate-800 text-white px-6 py-2 rounded-xl">Export CSV</button></div>
                 <div class="stats-card border-l-4 border-red-500"><button onclick="clearAllData()" class="text-red-600 font-bold">Clear All Data</button></div>
            </div>
        </main>
    </div>

    <script>
        let gameData = [];
        let trendChart;
        let distributionChart;
        let currentFormStep = 1;
        const totalSteps = 13;
        
        let liveGame = { s:0, d:0, t:0, hr:0, so:0, bb:0, hbp:0, outs:0, r:0, rbi:0, sb:0, ab:0, hits:0 };
        let currentABContext = null;
        let currentLiveId = null; // Track ID of game currently being edited

        function toggleNav(open) {
            document.getElementById('navSidebar').classList.toggle('active', open);
            document.getElementById('overlay').classList.toggle('active', open);
        }

        function closeAllMenus() { toggleNav(false); }

        function showPage(pageId) {
            document.querySelectorAll('.page-view').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId + 'Page').classList.remove('hidden');
            const titles = { dashboard: "Dashboard", liveGame: "Live Game Tracker", addData: "Add Game Data", glossary: "Glossary", dataManagement: "Data Management" };
            document.getElementById('pageTitle').textContent = titles[pageId] || "App";
            
            if (pageId === 'liveGame') initLiveGame();
            closeAllMenus();
        }

        function switchDashTab(tabId) {
            document.querySelectorAll('.dash-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`dash-section-${tabId}`).classList.remove('hidden');
            document.getElementById(`dash-tab-${tabId}`).classList.add('active');
        }

        // --- LIVE GAME LOGIC ---
        function initLiveGame() {
            const savedOpponent = localStorage.getItem('currentOpponent') || "";
            // Restore currentLiveId from storage if page reloaded
            const storedId = localStorage.getItem('currentLiveId');
            if (storedId) {
                currentLiveId = parseInt(storedId);
                // Try to find existing game data to populate local state
                const existing = gameData.find(g => g.id === currentLiveId);
                if (existing) {
                    liveGame = { 
                        s: existing.s || 0, d: existing.d || 0, t: existing.t || 0, hr: existing.hr || 0,
                        so: existing.so || 0, bb: existing.bb || 0, hbp: existing.hbp || 0, outs: existing.outs || 0,
                        r: existing.r || 0, rbi: existing.rbi || 0, sb: existing.sb || 0,
                        ab: existing.ab || 0, hits: existing.hits || 0
                    };
                } else {
                    // ID exists but game not found (deleted?), reset
                    currentLiveId = null;
                    localStorage.removeItem('currentLiveId');
                    resetLiveGameData();
                }
            } else {
                resetLiveGameData();
            }

            document.getElementById('liveOpponent').value = savedOpponent;
            document.getElementById('liveDateDisplay').textContent = new Date().toLocaleDateString();
            updateLiveUI();
        }
        
        function persistOpponent() { localStorage.setItem('currentOpponent', document.getElementById('liveOpponent').value); }
        
        function resetLiveGameData() {
            liveGame = { s:0, d:0, t:0, hr:0, so:0, bb:0, hbp:0, outs:0, r:0, rbi:0, sb:0, ab:0, hits:0 };
            document.getElementById('liveABContext').classList.add('hidden');
            document.getElementById('liveKeypad').classList.remove('hidden');
        }

        function updateLiveUI() {
            liveGame.hits = liveGame.s + liveGame.d + liveGame.t + liveGame.hr;
            liveGame.ab = liveGame.hits + liveGame.so + liveGame.outs;
            const avg = liveGame.ab > 0 ? (liveGame.hits / liveGame.ab).toFixed(3).replace(/^0/, '') : ".000";
            
            document.getElementById('liveAB').textContent = liveGame.ab;
            document.getElementById('liveH').textContent = liveGame.hits;
            document.getElementById('liveRBI').textContent = liveGame.rbi;
            document.getElementById('liveR').textContent = liveGame.r;
            document.getElementById('liveAVG').textContent = avg;
        }

        function handleLiveResult(type) {
            currentABContext = { type: type, rbi: 0, sb: 0, r: 0 };
            const isHR = type === 'hr';
            
            if (isHR) { currentABContext.rbi = 1; currentABContext.r = 1; }

            document.getElementById('liveKeypad').classList.add('hidden');
            document.getElementById('liveABContext').classList.remove('hidden');
            
            showLiveStep(1);
        }

        function showLiveStep(step) {
            document.querySelectorAll('.live-step').forEach(el => el.classList.add('hidden'));
            
            if (step === 2) {
                const type = currentABContext.type;
                if (!['s', 'd', 't', 'bb', 'hbp'].includes(type)) {
                    return showLiveStep(3);
                }
            }
            if (step === 3) {
                const type = currentABContext.type;
                if (type === 'hr' || ['so', 'outs'].includes(type)) {
                    return showLiveStep(4);
                }
            }
            
            const stepMap = { 1: 'liveStepRBI', 2: 'liveStepSB', 3: 'liveStepRun', 4: 'liveStepConfirm' };
            document.getElementById(stepMap[step]).classList.remove('hidden');
            
            if (step === 1) document.getElementById('liveContextRBI').textContent = currentABContext.rbi;
            if (step === 2) document.getElementById('liveContextSB').textContent = currentABContext.sb;
            if (step === 4) updateLiveSummary();
        }

        function nextLiveStep(targetStep) {
            showLiveStep(targetStep);
        }

        function adjustLiveContext(field, delta) {
            if (field === 'rbi') currentABContext.rbi = Math.max(0, currentABContext.rbi + delta);
            if (field === 'sb') currentABContext.sb = Math.max(0, currentABContext.sb + delta);
            if (field === 'rbi') document.getElementById('liveContextRBI').textContent = currentABContext.rbi;
            if (field === 'sb') document.getElementById('liveContextSB').textContent = currentABContext.sb;
        }

        function setLiveRun(scored) {
            currentABContext.r = scored ? 1 : 0;
        }

        function updateLiveSummary() {
            const names = {s:'Single', d:'Double', t:'Triple', hr:'Home Run', bb:'Walk', hbp:'HBP', so:'Strikeout', outs:'Out'};
            document.getElementById('liveSummaryText').innerHTML = `
                <div class="font-bold text-lg mb-2">${names[currentABContext.type]}</div>
                <div class="grid grid-cols-3 gap-2 text-xs font-bold text-slate-500 uppercase">
                    <div>RBI: <span class="text-slate-900">${currentABContext.rbi}</span></div>
                    <div>SB: <span class="text-slate-900">${currentABContext.sb}</span></div>
                    <div>Run: <span class="text-slate-900">${currentABContext.r ? 'YES' : 'NO'}</span></div>
                </div>
            `;
        }

        function cancelLiveAB() {
            currentABContext = null;
            document.getElementById('liveABContext').classList.add('hidden');
            document.getElementById('liveKeypad').classList.remove('hidden');
            document.querySelectorAll('.live-step').forEach(el => el.classList.add('hidden'));
        }

        function confirmLiveAB() {
            if (!currentABContext) return;
            
            // 1. Update local live state
            const type = currentABContext.type;
            liveGame[type]++;
            liveGame.rbi += currentABContext.rbi;
            liveGame.sb += currentABContext.sb;
            liveGame.r += currentABContext.r;
            
            // Recalc derived stats for the entry
            liveGame.hits = liveGame.s + liveGame.d + liveGame.t + liveGame.hr;
            liveGame.ab = liveGame.hits + liveGame.so + liveGame.outs;

            // 2. Sync to Game Log (gameData)
            const todayStr = new Date().toISOString().split('T')[0];
            const oppName = document.getElementById('liveOpponent').value;

            if (currentLiveId) {
                // Update existing
                const idx = gameData.findIndex(g => g.id === currentLiveId);
                if (idx !== -1) {
                    gameData[idx] = { 
                        ...gameData[idx], 
                        opponent: oppName,
                        ...liveGame 
                    };
                } else {
                    // Fallback if ID lost
                    currentLiveId = null; 
                }
            }

            if (!currentLiveId) {
                // Create new
                currentLiveId = Date.now();
                localStorage.setItem('currentLiveId', currentLiveId);
                const entry = {
                    id: currentLiveId,
                    date: todayStr,
                    opponent: oppName,
                    ...liveGame
                };
                gameData.push(entry);
            }

            // 3. Persist and Refresh Dashboard
            calculate(); // Saves to localStorage bb_stats_v14
            
            updateLiveUI();
            cancelLiveAB();
        }

        function finalizeLiveGame() {
            if (confirm("Finish game and start a new one?")) {
                // Game is already saved in gameData via confirmLiveAB
                // We just need to reset the tracker
                currentLiveId = null;
                localStorage.removeItem('currentLiveId');
                resetLiveGameData();
                updateLiveUI();
                showPage('dashboard');
            }
        }

        // --- MANUAL ENTRY LOGIC ---
        function getRequiredMinAB() {
            const hits = ['s', 'd', 't', 'hr'].reduce((sum, id) => sum + (parseInt(document.getElementById(id).value) || 0), 0);
            const so = parseInt(document.getElementById('so').value) || 0;
            return hits + so;
        }

        function stepVal(id, delta) {
            const el = document.getElementById(id);
            if (!el) return;
            const limits = getLimits();
            let newVal = (parseInt(el.value) || 0) + delta;
            
            if (id === 'ab') newVal = Math.max(limits.minAb, newVal);
            else if (id === 'r') newVal = Math.min(Math.max(limits.minR, newVal), limits.maxR);
            else if (id === 'rbi') newVal = Math.min(Math.max(limits.minRbi, newVal), limits.maxRbi);
            else if (id === 'sb') newVal = Math.min(Math.max(0, newVal), limits.maxSb);
            else newVal = Math.max(0, newVal);
            
            el.value = newVal;
            
            if (['s', 'd', 't', 'hr', 'so'].includes(id)) {
                 const minAB = getRequiredMinAB();
                 const abEl = document.getElementById('ab');
                 if (parseInt(abEl.value) < minAB) abEl.value = minAB;
            }

            updateStepConstraints();
            if (currentFormStep === totalSteps) updatePreview();
        }

        function updateStepConstraints() {
            const limits = getLimits();
            const enforceLimits = (id, min, max) => {
                const el = document.getElementById(id);
                if (!el) return;
                let val = parseInt(el.value) || 0;
                if (val < min) el.value = min;
                if (max !== undefined && val > max) el.value = max;
                const plusBtn = document.getElementById(id + 'Plus');
                const minusBtn = document.getElementById(id + 'Minus');
                if (plusBtn) plusBtn.disabled = parseInt(el.value) >= max;
                if (minusBtn) minusBtn.disabled = parseInt(el.value) <= min;
            };
            enforceLimits('r', limits.minR, limits.maxR);
            enforceLimits('rbi', limits.minRbi, limits.maxRbi);
            enforceLimits('sb', 0, limits.maxSb);
        }

        function handleNext() {
            if (currentFormStep === 1 && !document.getElementById('date').value) return;
            if (currentFormStep === 2) {
                const min = getRequiredMinAB();
                if ((parseInt(document.getElementById('ab').value)||0) < min) {
                    document.getElementById('abWarning').classList.remove('hidden');
                    return;
                }
            }
            document.getElementById('abWarning')?.classList.add('hidden');
            if (currentFormStep < totalSteps) { currentFormStep++; updateFormUI(); }
        }

        function prevStep() { if (currentFormStep > 1) { currentFormStep--; updateFormUI(); } }

        function updateFormUI() {
            document.getElementById('stepIndicator').textContent = `Step ${currentFormStep} of ${totalSteps}`;
            document.querySelectorAll('.step-content').forEach((el, idx) => el.classList.toggle('hidden', (idx + 1) !== currentFormStep));
            document.getElementById('backBtn').classList.toggle('hidden', currentFormStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentFormStep === totalSteps);
            document.getElementById('submitBtn').classList.toggle('hidden', currentFormStep !== totalSteps);
            updateStepConstraints();
            if (currentFormStep === totalSteps) updatePreview();
        }

        function buildFullReview() {
            const fields = [
                { l: 'AB', v: 'ab' }, { l: 'Singles', v: 's' }, { l: 'Doubles', v: 'd' },
                { l: 'Triples', v: 't' }, { l: 'Home Runs', v: 'hr' }, { l: 'Strikeouts', v: 'so' },
                { l: 'Walks', v: 'bb' }, { l: 'HBP', v: 'hbp' }, { l: 'Runs', v: 'r' },
                { l: 'RBIs', v: 'rbi' }, { l: 'SB', v: 'sb' }
            ];
            const grid = document.getElementById('fullReviewGrid');
            grid.innerHTML = fields.map(f => `
                <div class="flex justify-between border-b border-blue-100 pb-1">
                    <span class="text-blue-400 font-bold uppercase text-[10px]">${f.l}</span>
                    <strong class="text-blue-900">${document.getElementById(f.v).value}</strong>
                </div>
            `).join('');
            const ab = parseInt(document.getElementById('ab').value) || 0;
            const h = ['s', 'd', 't', 'hr'].reduce((s, id) => s + (parseInt(document.getElementById(id).value) || 0), 0);
            const avg = ab > 0 ? (h / ab).toFixed(3).replace(/^0/, '') : ".000";
            document.getElementById('reviewCalculated').innerHTML = `<div class="flex justify-between items-center"><span class="text-xs font-black text-blue-800 uppercase">Game AVG</span><span class="text-2xl font-black text-blue-600">${avg}</span></div>`;
        }

        function getLimits() {
            const getVal = (id) => parseInt(document.getElementById(id)?.value) || 0;
            const s = getVal('s'), d = getVal('d'), t = getVal('t'), hr = getVal('hr'), bb = getVal('bb'), hbp = getVal('hbp');
            const hits = s + d + t + hr;
            return { 
                minAb: hits + parseInt(document.getElementById('so').value||0),
                minR: hr, 
                maxR: hits + bb + hbp, 
                minRbi: hr, 
                maxRbi: (hits * 3) + bb + hbp + hr, 
                maxSb: ((s + bb + hbp) * 3) + (d * 2) + (t * 1) 
            };
        }

        function getStatsFromForm() {
            const getVal = (id) => parseInt(document.getElementById(id)?.value) || 0;
            const ab = getVal('ab'), s = getVal('s'), d = getVal('d'), t = getVal('t'), hr = getVal('hr');
            const so = getVal('so'), bb = getVal('bb'), hbp = getVal('hbp');
            const r = getVal('r'), rbi = getVal('rbi'), sb = getVal('sb');
            const hits = s + d + t + hr;
            return { ab, s, d, t, hr, hits, so, bb, hbp, r, rbi, sb };
        }

        function calculate() {
            const fmt = (v) => v.toFixed(3).replace(/^0/, '');
            if (!gameData.length) {
                ['avgDisplay','obpDisplay','slgDisplay','opsDisplay'].forEach(id => document.getElementById(id).textContent = '.000');
                renderTable(); return;
            }
            const totals = gameData.reduce((a, g) => {
                a.ab += g.ab; a.h += g.hits; a.s += g.s; a.d += g.d; a.t += g.t; a.hr += g.hr;
                a.bb += g.bb; a.hbp += g.hbp; a.so += g.so;
                return a;
            }, { ab:0, h:0, s:0, d:0, t:0, hr:0, bb:0, hbp:0, so:0 });
            const tb = totals.s + (totals.d * 2) + (totals.t * 3) + (totals.hr * 4);
            const avg = totals.ab > 0 ? totals.h / totals.ab : 0;
            const obp = (totals.ab + totals.bb + totals.hbp) > 0 ? (totals.h + totals.bb + totals.hbp) / (totals.ab + totals.bb + totals.hbp) : 0;
            const slg = totals.ab > 0 ? tb / totals.ab : 0;
            document.getElementById('avgDisplay').textContent = fmt(avg);
            document.getElementById('obpDisplay').textContent = fmt(obp);
            document.getElementById('slgDisplay').textContent = fmt(slg);
            document.getElementById('opsDisplay').textContent = fmt(obp + slg);
            updateCharts(totals);
            renderTable();
            localStorage.setItem('bb_stats_v14', JSON.stringify(gameData));
        }

        function updateCharts(totals) {
            const sorted = [...gameData].sort((a,b) => new Date(a.date) - new Date(b.date));
            let cH = 0, cAB = 0;
            trendChart.data.labels = sorted.length ? sorted.map(g => g.date.split('-').slice(1).join('/')) : ['None'];
            trendChart.data.datasets[0].data = sorted.length ? sorted.map(g => { cH += g.hits; cAB += g.ab; return cAB > 0 ? cH/cAB : 0; }) : [0];
            trendChart.update();

            distributionChart.data.datasets[0].data = [totals.s, totals.d, totals.t, totals.hr];
            distributionChart.update();
        }

        function renderTable() {
            const body = document.getElementById('statsTableBody');
            body.innerHTML = [...gameData].sort((a,b) => new Date(b.date) - new Date(a.date)).map(g => `
                <tr class="text-[11px] hover:bg-slate-50 transition">
                    <td class="px-4 py-4 font-bold text-slate-700">${g.date}</td>
                    <td class="px-4 py-4 text-slate-500">${g.opponent || '—'}</td>
                    <td class="px-2 py-4 text-center">${g.ab}</td>
                    <td class="px-2 py-4 text-center font-bold text-blue-600">${g.hits}</td>
                    <td class="px-2 py-4 text-center">${g.bb}</td>
                    <td class="px-2 py-4 text-center text-slate-400 italic">${g.so}</td>
                    <td class="px-2 py-4 text-center font-black">${g.ab > 0 ? (g.hits/g.ab).toFixed(3).replace(/^0/,'') : '.000'}</td>
                    <td class="px-4 py-3 text-right"><button onclick="deleteGame('${g.id}')" class="text-red-300 hover:text-red-500">×</button></td>
                </tr>
            `).join('');
        }

        function deleteGame(id) { if (confirm("Delete entry?")) { gameData = gameData.filter(g => String(g.id) !== String(id)); calculate(); } }
        function clearAllData() { if (confirm("Wipe all?")) { gameData = []; calculate(); } }
        
        function exportData() {
            if (!gameData.length) return;
            const headers = Object.keys(gameData[0]);
            const rows = gameData.map(g => headers.map(h => JSON.stringify(g[h] || "")).join(","));
            const csv = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `baseball_stats.csv`; a.click();
        }
        function handleCsvImport(event) { /* (Same CSV Logic) */ }

        document.getElementById('statsForm').onsubmit = (e) => {
            e.preventDefault();
            gameData.push({ id: Date.now(), date: document.getElementById('date').value, opponent: document.getElementById('opponent').value, ...getStatsFromForm() });
            calculate(); e.target.reset(); currentFormStep = 1; updateFormUI(); showPage('dashboard');
        };

        window.onload = () => {
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            const ctx1 = document.getElementById('performanceChart').getContext('2d');
            trendChart = new Chart(ctx1, { type:'line', data:{labels:[], datasets:[{data:[], borderColor:'#2563eb', tension:0.4, fill:true, backgroundColor:'rgba(37,99,235,0.05)', pointRadius:0}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, max:1}, x:{grid:{display:false}}}}});
            const ctx2 = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(ctx2, { type:'doughnut', data:{labels:['1B','2B','3B','HR'], datasets:[{data:[0,0,0,0], backgroundColor:['#3b82f6','#f43f5e','#eab308','#22c55e'], borderWidth:0}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, cutout:'70%'}});
            const saved = localStorage.getItem('bb_stats_v14'); 
            if (saved) gameData = JSON.parse(saved);
            calculate(); updateFormUI();
        };
    </script>
</body>
</html>
