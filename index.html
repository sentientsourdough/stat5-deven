<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baseball Stats Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        ::placeholder { color: #9ca3af; opacity: 1; }
        th, td { white-space: nowrap; }
        
        .stepper-btn {
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
            border-radius: 9999px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e3a8a;
            transition: all 0.2s;
            user-select: none;
        }
        .stepper-btn:hover { background-color: #e5e7eb; }
        .stepper-btn:active { transform: scale(0.9); }
        .stepper-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #navSidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #navSidebar.active {
            transform: translateX(0);
        }

        #overlay {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        #overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .sub-tab-btn {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .sub-tab-btn.active {
            color: #1e293b;
            border-bottom-color: #1e293b;
        }
        
        #importStatus { transition: all 0.3s; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-slate-900 overflow-x-hidden">

    <div id="overlay" onclick="closeAllMenus()" class="fixed inset-0 bg-slate-900/50 z-[60]"></div>
    
    <aside id="navSidebar" class="fixed top-0 left-0 h-full w-64 bg-white z-[70] shadow-2xl p-6">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-lg font-black text-blue-900 tracking-tight">MENU</h2>
            <button onclick="toggleNav(false)" class="p-2 hover:bg-slate-100 rounded-full transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav class="flex flex-col gap-2">
            <button onclick="showPage('dashboard')" class="flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition text-left">Dashboard</button>
            <button onclick="showPage('addData')" class="flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition text-left">Add Game</button>
            <button onclick="showPage('glossary')" class="flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition text-left">Glossary</button>
        </nav>
    </aside>

    <div class="max-w-6xl mx-auto">
        <header class="bg-white border-b sticky top-0 z-40 px-4 md:px-8">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center gap-4">
                    <button onclick="toggleNav(true)" class="p-2 hover:bg-slate-100 rounded-lg transition text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 class="text-xl font-black text-blue-900 tracking-tight">BASEBALL STATS</h1>
                </div>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <h2 id="pageTitle" class="text-2xl font-bold mb-6 text-slate-800">Dashboard</h2>

            <!-- DASHBOARD -->
            <div id="dashboardPage" class="page-view">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="stats-card border-t-4 border-blue-500">
                        <p class="text-slate-400 text-[10px] uppercase font-black tracking-wider">AVG</p>
                        <p id="avgDisplay" class="text-3xl font-black text-slate-800">.000</p>
                    </div>
                    <div class="stats-card border-t-4 border-red-500">
                        <p class="text-slate-400 text-[10px] uppercase font-black tracking-wider">OBP</p>
                        <p id="obpDisplay" class="text-3xl font-black text-slate-800">.000</p>
                    </div>
                    <div class="stats-card border-t-4 border-yellow-500">
                        <p class="text-slate-400 text-[10px] uppercase font-black tracking-wider">SLG</p>
                        <p id="slgDisplay" class="text-3xl font-black text-slate-800">.000</p>
                    </div>
                    <div class="stats-card border-t-4 border-green-500">
                        <p class="text-slate-400 text-[10px] uppercase font-black tracking-wider">OPS</p>
                        <p id="opsDisplay" class="text-3xl font-black text-slate-800">.000</p>
                    </div>
                </div>

                <div class="mb-6 border-b border-slate-200 flex gap-1 sm:gap-4 overflow-x-auto no-scrollbar">
                    <button onclick="switchDashTab('performance')" id="dash-tab-performance" class="sub-tab-btn active">Performance</button>
                    <button onclick="switchDashTab('metrics')" id="dash-tab-metrics" class="sub-tab-btn">Metric Profile</button>
                    <button onclick="switchDashTab('distribution')" id="dash-tab-distribution" class="sub-tab-btn">Hit Distribution</button>
                    <button onclick="switchDashTab('log')" id="dash-tab-log" class="sub-tab-btn">Game Log</button>
                </div>

                <div id="dash-section-performance" class="dash-section">
                    <div class="stats-card mb-8">
                        <h3 class="text-sm font-bold mb-6 text-slate-500 uppercase tracking-widest">Season Performance</h3>
                        <div class="h-64"><canvas id="performanceChart"></canvas></div>
                    </div>
                </div>

                <div id="dash-section-metrics" class="dash-section hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="stats-card">
                            <h3 class="text-sm font-bold mb-6 text-slate-500 uppercase tracking-widest text-center">Plate Discipline</h3>
                            <div class="flex justify-around text-center py-4">
                                <div><p class="text-xs font-bold text-slate-400 uppercase">Walks</p><p id="metricBB" class="text-2xl font-black text-slate-800">0</p></div>
                                <div><p class="text-xs font-bold text-slate-400 uppercase">Strikeouts</p><p id="metricSO" class="text-2xl font-black text-slate-800">0</p></div>
                            </div>
                        </div>
                        <div class="stats-card">
                            <h3 class="text-sm font-bold mb-6 text-slate-500 uppercase tracking-widest text-center">Power Metrics</h3>
                            <div class="flex justify-around text-center py-4">
                                <div><p class="text-xs font-bold text-slate-400 uppercase">ISO (Iso Power)</p><p id="metricISO" class="text-2xl font-black text-slate-800">.000</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dash-section-distribution" class="dash-section hidden">
                    <div class="stats-card mb-8">
                        <h3 class="text-sm font-bold mb-6 text-slate-500 uppercase tracking-widest">Hit Type Breakdown</h3>
                        <div class="h-64"><canvas id="distributionChart"></canvas></div>
                    </div>
                </div>

                <div id="dash-section-log" class="dash-section hidden">
                    <div class="stats-card overflow-x-auto mb-8">
                        <table class="min-w-full divide-y divide-slate-100">
                            <thead>
                                <tr class="text-left text-[10px] font-black text-slate-400 uppercase tracking-wider">
                                    <th class="px-4 py-3">Date</th>
                                    <th class="px-4 py-3">Opponent</th>
                                    <th class="px-2 py-3 text-center">AB</th>
                                    <th class="px-2 py-3 text-center">H</th>
                                    <th class="px-2 py-3 text-center">BB</th>
                                    <th class="px-2 py-3 text-center">SO</th>
                                    <th class="px-2 py-3 text-center">AVG</th>
                                    <th class="px-4 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- GLOSSARY PAGE -->
            <div id="glossaryPage" class="page-view hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="stats-card">
                        <strong class="block text-blue-600 text-xs font-black uppercase mb-1">AB: At Bats</strong>
                        <p class="text-sm text-slate-600 leading-relaxed">Total turns at bat, excluding walks (BB), hit by pitches (HBP), sacrifices, and catcher's interference.</p>
                    </div>
                    <div class="stats-card">
                        <strong class="block text-blue-600 text-xs font-black uppercase mb-1">AVG: Batting Average</strong>
                        <p class="text-sm text-slate-600 leading-relaxed">A measure of a batter's ability to get hits. Formula: <code>Total Hits (1B+2B+3B+HR) / AB</code>.</p>
                    </div>
                    <div class="stats-card">
                        <strong class="block text-blue-600 text-xs font-black uppercase mb-1">OBP: On-Base Percentage</strong>
                        <p class="text-sm text-slate-600 leading-relaxed">How often a batter reaches base. Formula: <code>(H + BB + HBP) / (AB + BB + HBP + SF)</code>.</p>
                    </div>
                    <div class="stats-card">
                        <strong class="block text-blue-600 text-xs font-black uppercase mb-1">SLG: Slugging Percentage</strong>
                        <p class="text-sm text-slate-600 leading-relaxed">Total bases per at-bat. Formula: <code>(1B + 2*2B + 3*3B + 4*HR) / AB</code>.</p>
                    </div>
                    <div class="stats-card">
                        <strong class="block text-blue-600 text-xs font-black uppercase mb-1">OPS: On-Base Plus Slugging</strong>
                        <p class="text-sm text-slate-600 leading-relaxed">The combined measure of a player's ability to get on base and hit for power. Formula: <code>OBP + SLG</code>.</p>
                    </div>
                    <div class="stats-card">
                        <strong class="block text-blue-600 text-xs font-black uppercase mb-1">RBI: Runs Batted In</strong>
                        <p class="text-sm text-slate-600 leading-relaxed">The number of runs that score safely as a result of the batter's action (hit, walk with bases loaded, etc).</p>
                    </div>
                </div>
            </div>

            <!-- ADD DATA PAGE -->
            <div id="addDataPage" class="page-view hidden max-w-lg mx-auto space-y-8">
                <!-- Manual Entry Section -->
                <div class="stats-card min-h-[500px] flex flex-col">
                    <div class="flex justify-between items-start mb-6">
                        <h2 id="formHeader" class="text-xl font-bold">New Entry</h2>
                        <span id="stepIndicator" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">Step 1 of 13</span>
                    </div>
                    <form id="statsForm" class="flex-grow flex flex-col justify-between">
                        <div id="step1" class="step-content space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Date</label>
                                <input type="date" id="date" required class="w-full rounded-lg border border-slate-200 p-3 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Opponent</label>
                                <input type="text" id="opponent" placeholder="e.g. Mudhens" class="w-full rounded-lg border border-slate-200 p-3 focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>

                        <div id="stepperContainer">
                            <div id="step2" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">At Bats (AB)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('ab', -1)" class="stepper-btn">-</button><input type="number" id="ab" value="0" readonly class="text-5xl font-black w-24 text-center outline-none bg-transparent"><button type="button" onclick="stepVal('ab', 1)" class="stepper-btn">+</button></div><p id="abWarning" class="text-[10px] text-red-500 font-bold hidden uppercase">AB must be ≥ Total Hits + Strikeouts</p></div>
                            <div id="step3" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">Singles (1B)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('s', -1)" class="stepper-btn">-</button><input type="number" id="s" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" onclick="stepVal('s', 1)" class="stepper-btn">+</button></div></div>
                            <div id="step4" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">Doubles (2B)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('d', -1)" class="stepper-btn">-</button><input type="number" id="d" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" onclick="stepVal('d', 1)" class="stepper-btn">+</button></div></div>
                            <div id="step5" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">Triples (3B)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('t', -1)" class="stepper-btn">-</button><input type="number" id="t" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" onclick="stepVal('t', 1)" class="stepper-btn">+</button></div></div>
                            <div id="step6" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">Home Runs (HR)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('hr', -1)" class="stepper-btn">-</button><input type="number" id="hr" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" onclick="stepVal('hr', 1)" class="stepper-btn">+</button></div></div>
                            <div id="step7" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">Strikeouts (SO)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('so', -1)" class="stepper-btn">-</button><input type="number" id="so" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" onclick="stepVal('so', 1)" class="stepper-btn">+</button></div></div>
                            <div id="step8" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">Walks (BB)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('bb', -1)" class="stepper-btn">-</button><input type="number" id="bb" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" onclick="stepVal('bb', 1)" class="stepper-btn">+</button></div></div>
                            <div id="step9" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">Hit by Pitch (HBP)?</p><div class="flex items-center justify-center gap-6"><button type="button" onclick="stepVal('hbp', -1)" class="stepper-btn">-</button><input type="number" id="hbp" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" onclick="stepVal('hbp', 1)" class="stepper-btn">+</button></div></div>
                            <div id="step10" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">Runs (R)?</p><div class="flex items-center justify-center gap-6"><button type="button" id="rMinus" onclick="stepVal('r', -1)" class="stepper-btn">-</button><input type="number" id="r" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" id="rPlus" onclick="stepVal('r', 1)" class="stepper-btn">+</button></div></div>
                            <div id="step11" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">RBIs?</p><div class="flex items-center justify-center gap-6"><button type="button" id="rbiMinus" onclick="stepVal('rbi', -1)" class="stepper-btn">-</button><input type="number" id="rbi" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" id="rbiPlus" onclick="stepVal('rbi', 1)" class="stepper-btn">+</button></div></div>
                            <div id="step12" class="step-content hidden space-y-6 text-center"><p class="text-slate-500 text-sm font-medium">Stolen Bases (SB)?</p><div class="flex items-center justify-center gap-6"><button type="button" id="sbMinus" onclick="stepVal('sb', -1)" class="stepper-btn">-</button><input type="number" id="sb" value="0" readonly class="text-5xl font-black w-20 text-center outline-none bg-transparent"><button type="button" id="sbPlus" onclick="stepVal('sb', 1)" class="stepper-btn">+</button></div></div>
                            <!-- Step 13: Review -->
                            <div id="step13" class="step-content hidden">
                                <div class="bg-blue-50 rounded-xl p-4 border border-blue-100 overflow-y-auto max-h-[300px]">
                                    <h3 class="text-[10px] font-black text-blue-800 uppercase mb-4 text-center">Summary Review</h3>
                                    <div id="fullReviewGrid" class="grid grid-cols-2 gap-y-3 gap-x-6 text-sm"></div>
                                    <div id="reviewCalculated" class="mt-6 pt-4 border-t border-blue-200"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-2 pt-6">
                            <button type="button" id="backBtn" onclick="prevStep()" class="hidden w-1/3 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl">Back</button>
                            <button type="button" id="nextBtn" onclick="handleNext()" class="flex-grow bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">Next</button>
                            <button type="submit" id="submitBtn" class="hidden flex-grow bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg">Save Game</button>
                        </div>
                    </form>
                </div>

                <!-- Transfer Data & Danger Zone -->
                <div class="stats-card space-y-6">
                     <h3 class="text-lg font-bold text-slate-800">Transfer Data</h3>
                     
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 border border-slate-100 rounded-xl bg-slate-50">
                            <h4 class="text-xs font-black text-slate-400 uppercase mb-3">Backup</h4>
                            <button onclick="exportData()" class="w-full bg-slate-800 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-700 transition">Export CSV</button>
                            <p class="text-[10px] text-slate-500 mt-2">Download all entries as a CSV file.</p>
                        </div>
                        
                        <div class="p-4 border border-slate-100 rounded-xl bg-slate-50">
                            <h4 class="text-xs font-black text-slate-400 uppercase mb-3">Restore</h4>
                            <label for="csvFileInput" class="w-full inline-block text-center bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 transition cursor-pointer">Import CSV</label>
                            <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="importData(event)">
                            <p class="text-[10px] text-slate-500 mt-2">Upload a previously exported CSV.</p>
                        </div>
                     </div>
                     
                     <div id="importStatus" class="hidden p-3 rounded-lg text-xs font-bold"></div>
                </div>

                <div class="stats-card border-l-4 border-red-500">
                     <h3 class="text-lg font-bold text-red-600 mb-2">Danger Zone</h3>
                     <p class="text-sm text-slate-500 mb-4">This will permanently delete all recorded games from this device.</p>
                     <button onclick="clearAllData()" class="bg-red-50 text-red-600 px-6 py-2 rounded-xl font-bold border border-red-100 hover:bg-red-600 hover:text-white transition">Clear All Data</button>
                </div>
            </div>

        </main>
    </div>

    <script>
        let gameData = [];
        let trendChart, distributionChart;
        let currentFormStep = 1;
        const totalSteps = 13;

        const PAGE_TITLES = {
            'dashboard': 'Dashboard',
            'addData': 'Add Game',
            'glossary': 'Glossary'
        };

        function toggleNav(open) {
            document.getElementById('navSidebar').classList.toggle('active', open);
            document.getElementById('overlay').classList.toggle('active', open);
        }

        function closeAllMenus() { toggleNav(false); }

        function showPage(pageId) {
            document.querySelectorAll('.page-view').forEach(p => p.classList.add('hidden'));
            const target = document.getElementById(pageId + 'Page');
            if (target) target.classList.remove('hidden');
            
            document.getElementById('pageTitle').textContent = PAGE_TITLES[pageId] || 'Dashboard';
            closeAllMenus();
        }

        function switchDashTab(tabId) {
            document.querySelectorAll('.dash-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`dash-section-${tabId}`).classList.remove('hidden');
            document.getElementById(`dash-tab-${tabId}`).classList.add('active');
        }

        function getRequiredMinAB() {
            const hits = ['s', 'd', 't', 'hr'].reduce((sum, id) => sum + (parseInt(document.getElementById(id).value) || 0), 0);
            const so = parseInt(document.getElementById('so').value) || 0;
            return hits + so;
        }

        function stepVal(id, delta) {
            const el = document.getElementById(id);
            let val = parseInt(el.value) || 0;
            
            if (id === 'ab') {
                const min = getRequiredMinAB();
                val = Math.max(min, val + delta);
            } else if (['s', 'd', 't', 'hr', 'so'].includes(id)) {
                if (delta < 0) {
                    val = Math.max(0, val + delta);
                } else {
                    const currentAB = parseInt(document.getElementById('ab').value) || 0;
                    const othersSum = ['s', 'd', 't', 'hr', 'so']
                        .filter(key => key !== id)
                        .reduce((sum, key) => sum + (parseInt(document.getElementById(key).value) || 0), 0);
                    
                    if (othersSum + val + delta <= currentAB) {
                        val += delta;
                    } else {
                        document.getElementById('ab').value = othersSum + val + delta;
                        val += delta;
                    }
                }
            } else {
                val = Math.max(0, val + delta);
            }
            el.value = val;
        }

        function handleNext() {
            if (currentFormStep === 1 && !document.getElementById('date').value) return;
            if (currentFormStep === 2) {
                const min = getRequiredMinAB();
                const currentAB = parseInt(document.getElementById('ab').value) || 0;
                if (currentAB < min) {
                    document.getElementById('abWarning').classList.remove('hidden');
                    return;
                }
            }
            document.getElementById('abWarning')?.classList.add('hidden');
            if (currentFormStep < totalSteps) { currentFormStep++; updateFormUI(); }
        }

        function prevStep() { if (currentFormStep > 1) { currentFormStep--; updateFormUI(); } }

        function updateFormUI() {
            document.getElementById('stepIndicator').textContent = `Step ${currentFormStep} of ${totalSteps}`;
            document.querySelectorAll('.step-content').forEach((el, idx) => el.classList.toggle('hidden', (idx + 1) !== currentFormStep));
            document.getElementById('backBtn').classList.toggle('hidden', currentFormStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentFormStep === totalSteps);
            document.getElementById('submitBtn').classList.toggle('hidden', currentFormStep !== totalSteps);
            if (currentFormStep === totalSteps) buildFullReview();
        }

        function buildFullReview() {
            const fields = [
                { l: 'AB', v: 'ab' }, { l: '1B', v: 's' }, { l: '2B', v: 'd' },
                { l: '3B', v: 't' }, { l: 'HR', v: 'hr' }, { l: 'SO', v: 'so' },
                { l: 'BB', v: 'bb' }, { l: 'HBP', v: 'hbp' }, { l: 'R', v: 'r' },
                { l: 'RBI', v: 'rbi' }, { l: 'SB', v: 'sb' }
            ];
            const grid = document.getElementById('fullReviewGrid');
            grid.innerHTML = fields.map(f => `
                <div class="flex justify-between border-b border-blue-100 pb-1">
                    <span class="text-blue-400 font-bold uppercase text-[10px]">${f.l}</span>
                    <strong class="text-blue-900">${document.getElementById(f.v).value}</strong>
                </div>
            `).join('');
            const ab = parseInt(document.getElementById('ab').value) || 0;
            const h = ['s', 'd', 't', 'hr'].reduce((s, id) => s + (parseInt(document.getElementById(id).value) || 0), 0);
            const avg = ab > 0 ? (h / ab).toFixed(3).replace(/^0/, '') : ".000";
            document.getElementById('reviewCalculated').innerHTML = `<div class="flex justify-between items-center"><span class="text-xs font-black text-blue-800 uppercase">Game AVG</span><span class="text-2xl font-black text-blue-600">${avg}</span></div>`;
        }

        function calculate() {
            const fmt = (v) => v.toFixed(3).replace(/^0/, '');
            if (!gameData.length) {
                ['avgDisplay','obpDisplay','slgDisplay','opsDisplay'].forEach(id => document.getElementById(id).textContent = '.000');
                ['metricBB', 'metricSO'].forEach(id => document.getElementById(id).textContent = '0');
                document.getElementById('metricISO').textContent = '.000';
                renderTable(); 
                localStorage.setItem('bb_stats_v12', JSON.stringify([]));
                updateCharts({ ab:0, h:0, s:0, d:0, t:0, hr:0, bb:0, hbp:0, so:0 });
                return;
            }

            const totals = gameData.reduce((a, g) => {
                a.ab += g.ab; a.h += g.h; a.s += g.s; a.d += g.d; a.t += g.t; a.hr += g.hr;
                a.bb += g.bb; a.hbp += g.hbp; a.so += g.so;
                return a;
            }, { ab:0, h:0, s:0, d:0, t:0, hr:0, bb:0, hbp:0, so:0 });

            const tb = totals.s + (totals.d * 2) + (totals.t * 3) + (totals.hr * 4);
            const avg = totals.ab > 0 ? totals.h / totals.ab : 0;
            const obp = (totals.ab + totals.bb + totals.hbp) > 0 ? (totals.h + totals.bb + totals.hbp) / (totals.ab + totals.bb + totals.hbp) : 0;
            const slg = totals.ab > 0 ? tb / totals.ab : 0;

            document.getElementById('avgDisplay').textContent = fmt(avg);
            document.getElementById('obpDisplay').textContent = fmt(obp);
            document.getElementById('slgDisplay').textContent = fmt(slg);
            document.getElementById('opsDisplay').textContent = fmt(obp + slg);
            document.getElementById('metricBB').textContent = totals.bb;
            document.getElementById('metricSO').textContent = totals.so;
            document.getElementById('metricISO').textContent = fmt(slg - avg);

            updateCharts(totals);
            renderTable();
            localStorage.setItem('bb_stats_v12', JSON.stringify(gameData));
        }

        function updateCharts(totals) {
            const sorted = [...gameData].sort((a,b) => new Date(a.date) - new Date(b.date));
            let cH = 0, cAB = 0;
            trendChart.data.labels = sorted.length ? sorted.map(g => g.date.split('-').slice(1).join('/')) : ['None'];
            trendChart.data.datasets[0].data = sorted.length ? sorted.map(g => { cH += g.h; cAB += g.ab; return cAB > 0 ? cH/cAB : 0; }) : [0];
            trendChart.update();

            distributionChart.data.datasets[0].data = [totals.s, totals.d, totals.t, totals.hr];
            distributionChart.update();
        }

        function renderTable() {
            const body = document.getElementById('statsTableBody');
            body.innerHTML = [...gameData].sort((a,b) => new Date(b.date) - new Date(a.date)).map(g => `
                <tr class="text-[11px] hover:bg-slate-50 transition">
                    <td class="px-4 py-3 font-bold">${g.date}</td>
                    <td class="px-4 py-3 text-slate-500">${g.opponent || '—'}</td>
                    <td class="px-2 py-3 text-center">${g.ab}</td>
                    <td class="px-2 py-3 text-center font-bold text-blue-600">${g.h}</td>
                    <td class="px-2 py-3 text-center">${g.bb}</td>
                    <td class="px-2 py-3 text-center text-slate-400 italic">${g.so}</td>
                    <td class="px-2 py-3 text-center font-black">${g.ab > 0 ? (g.h/g.ab).toFixed(3).replace(/^0/,'') : '.000'}</td>
                    <td class="px-4 py-3 text-right"><button onclick="deleteGame('${g.id}')" class="text-red-300 hover:text-red-500 text-xl font-bold leading-none">×</button></td>
                </tr>
            `).join('');
        }

        function deleteGame(id) { if (confirm("Delete this entry?")) { gameData = gameData.filter(g => String(g.id) !== String(id)); calculate(); } }
        function clearAllData() { if (confirm("This will permanently delete ALL data. Are you sure?")) { gameData = []; calculate(); } }
        
        function exportData() {
            if (!gameData.length) return;
            const headers = Object.keys(gameData[0]);
            const rows = gameData.map(g => headers.map(h => JSON.stringify(g[h] || "")).join(","));
            const csv = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', ''); a.setAttribute('href', url);
            a.setAttribute('download', `baseball_stats_export.csv`);
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function importData(event) {
            const file = event.target.files[0];
            const statusEl = document.getElementById('importStatus');
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/).filter(line => line.trim());
                    if (lines.length < 2) throw new Error("File is empty or invalid format.");
                    
                    const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, ''));
                    const rows = lines.slice(1).map(line => {
                        const values = line.split(',').map(v => v.replace(/^"|"$/g, ''));
                        const obj = {};
                        headers.forEach((h, i) => {
                            let val = values[i];
                            if (!isNaN(val) && val !== "" && h !== 'date' && h !== 'opponent') {
                                obj[h] = parseFloat(val);
                            } else {
                                obj[h] = val;
                            }
                        });
                        return obj;
                    });

                    if (!rows[0].ab && rows[0].ab !== 0) throw new Error("Incompatible CSV format.");

                    const existingIds = new Set(gameData.map(g => String(g.id)));
                    const newEntries = rows.filter(r => !existingIds.has(String(r.id)));
                    
                    gameData = [...gameData, ...newEntries];
                    calculate();
                    
                    statusEl.textContent = `Success: Imported ${newEntries.length} new entries.`;
                    statusEl.className = "p-3 rounded-lg text-xs font-bold bg-green-100 text-green-700 block mt-4";
                    event.target.value = ""; 
                } catch (err) {
                    statusEl.textContent = `Error: ${err.message}`;
                    statusEl.className = "p-3 rounded-lg text-xs font-bold bg-red-100 text-red-700 block mt-4";
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('statsForm').onsubmit = (e) => {
            e.preventDefault();
            const getVal = (id) => parseInt(document.getElementById(id).value) || 0;
            const s = getVal('s'), d = getVal('d'), t = getVal('t'), hr = getVal('hr');
            gameData.push({
                id: Date.now(),
                date: document.getElementById('date').value,
                opponent: document.getElementById('opponent').value,
                ab: getVal('ab'), s, d, t, hr, h: (s+d+t+hr),
                so: getVal('so'), bb: getVal('bb'), hbp: getVal('hbp'),
                r: getVal('r'), rbi: getVal('rbi'), sb: getVal('sb')
            });
            calculate(); e.target.reset(); currentFormStep = 1; updateFormUI(); showPage('dashboard');
        };

        window.onload = () => {
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            const ctx1 = document.getElementById('performanceChart').getContext('2d');
            trendChart = new Chart(ctx1, { type:'line', data:{labels:[], datasets:[{data:[], borderColor:'#2563eb', tension:0.4, fill:true, backgroundColor:'rgba(37,99,235,0.05)', pointRadius:0}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, min:0, max:1}, x:{grid:{display:false}}}}});
            const ctx2 = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(ctx2, { type:'doughnut', data:{labels:['1B','2B','3B','HR'], datasets:[{data:[0,0,0,0], backgroundColor:['#3b82f6','#f43f5e','#eab308','#22c55e'], borderWidth:0}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, cutout:'70%'}});
            const saved = localStorage.getItem('bb_stats_v12');
            if (saved) gameData = JSON.parse(saved);
            calculate();
        };
    </script>
</body>
</html>
